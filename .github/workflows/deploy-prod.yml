name: Deploy to Production Environment

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.2.3)'
        required: true
        type: string
      service:
        description: 'Service to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - public-backend
          - public-frontend
          - admin-backend
          - admin-frontend
  release:
    types: [published]

env:
  REGISTRY: ${{ secrets.HARBOR_REGISTRY || 'harbor.platform.example.com' }}
  IMAGE_PREFIX: project
  NAMESPACE: prod
  CLUSTER: prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # Requires approval
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.PROD_KUBECONFIG }}" | base64 -d > /tmp/kubeconfig
          export KUBECONFIG=/tmp/kubeconfig
          kubectl cluster-info

      - name: Determine image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${{ github.event.inputs.release_tag }}"
          fi
          # Remove 'v' prefix if present
          TAG=${TAG#v}
          echo "RELEASE_TAG=release-${TAG}" >> $GITHUB_OUTPUT
          echo "Using release tag: release-${TAG}"

      - name: Deploy public-backend
        if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'public-backend' }}
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          helm upgrade --install public-backend charts/public-backend \
            --namespace ${NAMESPACE} \
            --create-namespace \
            -f env-values/prod/global.yaml \
            -f env-values/prod/public-backend.yaml \
            --set image.tag=${{ steps.image-tag.outputs.RELEASE_TAG }} \
            --set image.repository=${REGISTRY}/${IMAGE_PREFIX}/public-backend \
            --wait --timeout=10m

      - name: Deploy public-frontend
        if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'public-frontend' }}
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          helm upgrade --install public-frontend charts/public-frontend \
            --namespace ${NAMESPACE} \
            --create-namespace \
            -f env-values/prod/global.yaml \
            -f env-values/prod/public-frontend.yaml \
            --set image.tag=${{ steps.image-tag.outputs.RELEASE_TAG }} \
            --set image.repository=${REGISTRY}/${IMAGE_PREFIX}/public-frontend \
            --wait --timeout=10m

      - name: Deploy admin-backend
        if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'admin-backend' }}
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          helm upgrade --install admin-backend charts/admin-backend \
            --namespace ${NAMESPACE} \
            --create-namespace \
            -f env-values/prod/global.yaml \
            -f env-values/prod/admin-backend.yaml \
            --set image.tag=${{ steps.image-tag.outputs.RELEASE_TAG }} \
            --set image.repository=${REGISTRY}/${IMAGE_PREFIX}/admin-backend \
            --wait --timeout=10m

      - name: Deploy admin-frontend
        if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'admin-frontend' }}
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          helm upgrade --install admin-frontend charts/admin-frontend \
            --namespace ${NAMESPACE} \
            --create-namespace \
            -f env-values/prod/global.yaml \
            -f env-values/prod/admin-frontend.yaml \
            --set image.tag=${{ steps.image-tag.outputs.RELEASE_TAG }} \
            --set image.repository=${REGISTRY}/${IMAGE_PREFIX}/admin-frontend \
            --wait --timeout=10m

      - name: Run post-deploy smoke tests
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          # Wait for services to be ready
          kubectl wait --for=condition=available --timeout=5m deployment/public-backend -n ${NAMESPACE} || true
          kubectl wait --for=condition=available --timeout=5m deployment/public-frontend -n ${NAMESPACE} || true
          
          # Run smoke tests
          echo "Running post-deploy smoke tests..."
          # Add actual test commands here

      - name: Promote to latest tag
        if: success()
        run: |
          # Tag the release image as latest in Harbor
          echo "Promoting release-${TAG} to latest after successful deployment"
          # This would require Harbor API calls
