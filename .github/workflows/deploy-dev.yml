name: Deploy to Dev Environment

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'services/**'
      - 'charts/**'
      - 'env-values/dev/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (all, public-backend, public-frontend, admin-backend, admin-frontend)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - public-backend
          - public-frontend
          - admin-backend
          - admin-frontend

env:
  REGISTRY: ${{ secrets.HARBOR_REGISTRY || 'harbor.platform.example.com' }}
  IMAGE_PREFIX: project
  NAMESPACE: dev
  CLUSTER: dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.DEV_KUBECONFIG }}" | base64 -d > /tmp/kubeconfig
          export KUBECONFIG=/tmp/kubeconfig
          kubectl cluster-info

      - name: Get image SHA from CI
        id: image-sha
        run: |
          # Get the latest commit SHA
          SHA=$(git rev-parse --short HEAD)
          echo "IMAGE_TAG=sha-${SHA}" >> $GITHUB_OUTPUT
          echo "Using image tag: sha-${SHA}"

      - name: Deploy public-backend
        if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'public-backend' || github.event_name == 'push' }}
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          helm upgrade --install public-backend charts/public-backend \
            --namespace ${NAMESPACE} \
            --create-namespace \
            -f env-values/dev/global.yaml \
            -f env-values/dev/public-backend.yaml \
            --set image.tag=${{ steps.image-sha.outputs.IMAGE_TAG }} \
            --set image.repository=${REGISTRY}/${IMAGE_PREFIX}/public-backend \
            --wait --timeout=5m

      - name: Deploy public-frontend
        if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'public-frontend' || github.event_name == 'push' }}
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          helm upgrade --install public-frontend charts/public-frontend \
            --namespace ${NAMESPACE} \
            --create-namespace \
            -f env-values/dev/global.yaml \
            -f env-values/dev/public-frontend.yaml \
            --set image.tag=${{ steps.image-sha.outputs.IMAGE_TAG }} \
            --set image.repository=${REGISTRY}/${IMAGE_PREFIX}/public-frontend \
            --wait --timeout=5m

      - name: Deploy admin-backend
        if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'admin-backend' || github.event_name == 'push' }}
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          helm upgrade --install admin-backend charts/admin-backend \
            --namespace ${NAMESPACE} \
            --create-namespace \
            -f env-values/dev/global.yaml \
            -f env-values/dev/admin-backend.yaml \
            --set image.tag=${{ steps.image-sha.outputs.IMAGE_TAG }} \
            --set image.repository=${REGISTRY}/${IMAGE_PREFIX}/admin-backend \
            --wait --timeout=5m

      - name: Deploy admin-frontend
        if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == 'admin-frontend' || github.event_name == 'push' }}
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          helm upgrade --install admin-frontend charts/admin-frontend \
            --namespace ${NAMESPACE} \
            --create-namespace \
            -f env-values/dev/global.yaml \
            -f env-values/dev/admin-frontend.yaml \
            --set image.tag=${{ steps.image-sha.outputs.IMAGE_TAG }} \
            --set image.repository=${REGISTRY}/${IMAGE_PREFIX}/admin-frontend \
            --wait --timeout=5m

      - name: Run smoke tests
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          # Wait for services to be ready
          kubectl wait --for=condition=available --timeout=2m deployment/public-backend -n ${NAMESPACE} || true
          kubectl wait --for=condition=available --timeout=2m deployment/public-frontend -n ${NAMESPACE} || true
          
          # Basic health check
          echo "Smoke tests completed"

      - name: Tag image as canary
        if: success()
        run: |
          # Tag the sha- image as canary in Harbor
          echo "Tagging image as canary after successful deployment"
          # This would require Harbor API calls or docker tag/push
